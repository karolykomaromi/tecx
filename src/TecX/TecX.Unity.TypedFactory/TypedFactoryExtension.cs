extern alias CC30;

namespace TecX.Unity.TypedFactory
{
    using System;
    using System.Collections.Generic;
    using System.Linq;
    using System.Reflection;

    using CC30.Castle.DynamicProxy;

    using Microsoft.Practices.Unity;

    using TecX.Common;

    public class TypedFactoryExtension : UnityContainerExtension, ITypedFactoryConfiguration
    {
        private ProxyGenerator generator;

        public void RegisterFactory(Type factoryType, string name, ITypedFactoryComponentSelector selector, LifetimeManager lifetime, params InjectionMember[] injectionMembers)
        {
            Guard.AssertNotNull(factoryType, "factoryType");
            Guard.AssertNotNull(selector, "selector");

            Guard.AssertCondition(
                factoryType.IsInterface,
                factoryType,
                "factoryType",
                "Cannot generate an implementation for a non-interface factory type.");

            this.AssertNoMethodHasOutParams(factoryType);

            if (lifetime == null)
            {
                lifetime = new TransientLifetimeManager();
            }

            injectionMembers = injectionMembers ?? new InjectionMember[0];

            InjectionMember factory = new InjectionFactory(container => this.GetAutoGeneratedFactory(factoryType, container, selector));

            injectionMembers = injectionMembers.Concat(new[] {factory }).ToArray();

            this.Container.RegisterType(factoryType, name, lifetime, injectionMembers);
        }

        protected override void Initialize()
        {
            this.generator = new ProxyGenerator();
        }

        private void AssertNoMethodHasOutParams(Type factoryType)
        {
            var methods = factoryType.GetMethods(BindingFlags.Instance | BindingFlags.Public);

            foreach (var method in methods)
            {
                foreach (var parameter in method.GetParameters())
                {
                    if (parameter.IsOut)
                    {
                        throw new ArgumentException("Methods in factory interface must not have out parameters", "TFactory");
                    }
                }
            }
        }

        private object GetAutoGeneratedFactory(Type factoryType, IUnityContainer container, ITypedFactoryComponentSelector selector)
        {
            return this.generator.CreateInterfaceProxyWithoutTarget(factoryType, new FactoryInterceptor(container, selector));
        }
    }
}
